---
phase: 01-foundation-refactoring
plan: 01
type: execute
---

<objective>
Extract shared matplotlib backend initialization to a dedicated utility module and improve backend selection logging.

Purpose: Eliminate duplicate code across labeler.py and click_collector.py, making future matplotlib-related changes safer and ensuring users know which backend is active.
Output: New `cryoem_annotation/core/matplotlib_utils.py` module, updated imports in both consuming files.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md

**Codebase constraints:**
- Use `[OK]`, `[ERROR]`, `[WARNING]` prefixes for status messages (ASCII only, no unicode)
- Use `except Exception:` not bare `except:`
- Follow snake_case for functions, PascalCase for classes
- Google-style docstrings for public functions

**Relevant source files:**
@cryoem_annotation/labeling/labeler.py (lines 28-43 have duplicate backend init)
@cryoem_annotation/annotation/click_collector.py (lines 52-71 have duplicate backend init)
@cryoem_annotation/core/logging_utils.py (existing logging pattern)

**Prior decisions affecting this phase:**
- Concerns vs integration: Both together - fix at touchpoints

**Deferred issues being addressed:**
- None (this is foundational cleanup)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create matplotlib_utils.py with backend initialization</name>
  <files>cryoem_annotation/core/matplotlib_utils.py</files>
  <action>
Create a new module `cryoem_annotation/core/matplotlib_utils.py` that:

1. Defines `setup_interactive_backend()` function that:
   - Tries backends in order: Qt5Agg, MacOSX, TkAgg
   - Tests each by creating/closing a figure
   - Logs which backend was selected using StatusLogger: `[OK] Matplotlib backend: {backend_name}`
   - If none work, logs warning: `[WARNING] Could not set interactive backend, using default`
   - Returns the name of the selected backend (or None if default)

2. Defines `get_active_backend()` function to query current backend name

3. Module-level call to `setup_interactive_backend()` so importing this module sets up matplotlib

4. Export plt already imported and in interactive mode (plt.ion() called)

Follow existing patterns from `logging_utils.py` for StatusLogger usage.
Use `except Exception:` not bare `except:`.
Add Google-style docstring to public functions.
  </action>
  <verify>
python -c "from cryoem_annotation.core.matplotlib_utils import setup_interactive_backend, get_active_backend, plt; print(get_active_backend())"
Should print a backend name without errors.
  </verify>
  <done>
- matplotlib_utils.py exists with setup_interactive_backend() and get_active_backend()
- Importing the module logs which backend was selected
- plt is exported in interactive mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Update labeler.py and click_collector.py to use shared utility</name>
  <files>cryoem_annotation/labeling/labeler.py, cryoem_annotation/annotation/click_collector.py</files>
  <action>
**In labeler.py:**
1. Remove lines 28-44 (the duplicate backend initialization code)
2. Replace with: `from cryoem_annotation.core.matplotlib_utils import plt`
3. Keep any other matplotlib imports that are specific to labeler (if any)

**In click_collector.py:**
1. Remove lines 52-71 (the duplicate backend initialization code including `plt.ion()`)
2. Replace with: `from cryoem_annotation.core.matplotlib_utils import plt`
3. Remove the duplicate `import matplotlib.pyplot as plt` at line 70
4. Keep any other matplotlib imports that are specific to click_collector (if any)

Ensure both files still have access to `plt` for their plotting operations.
Run the imports at module level (not lazy) since these files need matplotlib immediately.
  </action>
  <verify>
pytest tests/ -v -k "test_" --tb=short 2>/dev/null || echo "Tests checked"
python -c "from cryoem_annotation.labeling.labeler import SegmentationLabeler; print('labeler OK')"
python -c "from cryoem_annotation.annotation.click_collector import RealTimeClickCollector; print('click_collector OK')"
  </verify>
  <done>
- labeler.py imports plt from matplotlib_utils
- click_collector.py imports plt from matplotlib_utils
- No duplicate backend initialization code in either file
- Both modules import successfully
- Existing tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from cryoem_annotation.core.matplotlib_utils import plt"` succeeds and logs backend
- [ ] `python -c "from cryoem_annotation.labeling.labeler import SegmentationLabeler"` succeeds
- [ ] `python -c "from cryoem_annotation.annotation.click_collector import RealTimeClickCollector"` succeeds
- [ ] No duplicate backend setup code in labeler.py or click_collector.py
- [ ] `pytest tests/ -v --tb=short` passes (if tests exist)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- matplotlib_utils.py created with proper logging
- Duplicate code removed from both consumer files
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-refactoring/01-01-SUMMARY.md`:

# Phase 1 Plan 1: Matplotlib Utilities Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 01-02-PLAN.md
</output>
