---
phase: 04-output-extraction
plan: 01
type: execute
---

<objective>
Update extraction to support grid-aware output structure and per-grid summaries.

Purpose: Enable researchers to analyze segmentation results with grid context preserved, including per-grid statistics for comparing across grids.
Output: Grid-aware extractor with `grid_name` column in CSV outputs and per-grid summary statistics.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/03-grid-aware-ui/03-01-SUMMARY.md

**Key decisions from prior phases:**
- Output structure mirrors input: `results/{Grid}/{micrograph}/` for multi-grid, `results/{micrograph}/` for single-folder
- Annotator already saves `grid_name` in metadata.json (Phase 3)
- GridDataset pattern established for detecting multi-grid structures

**Relevant source files:**
@cryoem_annotation/extraction/extractor.py
@cryoem_annotation/cli/extract.py
@cryoem_annotation/core/grid_dataset.py
@tests/test_extraction/test_extractor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update extractor for grid-aware output</name>
  <files>cryoem_annotation/extraction/extractor.py</files>
  <action>
Update `extract_segmentation_data()` to detect multi-grid results structure and add grid context:

1. **Detect multi-grid structure:** Check if results folder contains subdirectories with their own `*/metadata.json` files (e.g., `results/Grid1/micro_001/metadata.json`). If so, treat each top-level subdirectory as a grid.

2. **Update glob pattern:** Currently uses `results_folder.glob("*/metadata.json")`. For multi-grid, need to check both `*/metadata.json` (single-folder) and `*/*/*/metadata.json` patterns, or detect structure first then glob appropriately.

3. **Extract grid_name from path:** For multi-grid structure, extract grid name from the path hierarchy. For single-folder, set `grid_name=None`.

4. **Add grid_name to metadata entries:** Include `grid_name` field in the metadata_list entries.

5. **Update CSV fieldnames:** Add `grid_name` after `micrograph_name` in `save_metadata_csv()` fieldnames list.

6. **Add per-grid summary in `print_summary()`:** After the combined summary, add a per-grid breakdown section showing:
   - Micrographs per grid
   - Segmentations per grid
   - Labeled vs unlabeled per grid

**Detection logic (similar to GridDataset):**
```python
# Check for multi-grid structure: subdirs containing subdirs with metadata.json
is_multi_grid = False
for item in results_folder.iterdir():
    if item.is_dir() and not item.name.startswith('.'):
        # Check if this subdir contains further subdirs with metadata.json
        nested_metadata = list(item.glob("*/metadata.json"))
        if nested_metadata:
            is_multi_grid = True
            break
```

**Glob patterns:**
- Single-folder: `results_folder.glob("*/metadata.json")`
- Multi-grid: `results_folder.glob("*/*/metadata.json")`

**Grid name extraction:**
- Multi-grid: `metadata_file.parent.parent.name` (Grid1 from results/Grid1/micro_001/metadata.json)
- Single-folder: `None`
  </action>
  <verify>
Run extraction on a mock multi-grid results folder and verify:
- `grid_name` appears in CSV output
- Per-grid summary shows correct counts
  </verify>
  <done>
- Multi-grid results structure detected automatically
- `grid_name` column added to metadata CSV (None for single-folder mode)
- Per-grid summary statistics printed after combined summary
- Single-folder mode continues to work unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add multi-grid extraction tests</name>
  <files>tests/test_extraction/test_extractor.py</files>
  <action>
Add test class `TestMultiGridExtraction` with the following tests:

1. **test_detects_multi_grid_structure:** Create nested results structure `Grid1/micro_001/metadata.json`, verify extraction detects multi-grid mode.

2. **test_extracts_grid_name_from_path:** Verify `grid_name` is correctly extracted from multi-grid folder structure.

3. **test_grid_name_in_metadata_csv:** Verify `grid_name` column appears in CSV output with correct values.

4. **test_single_folder_has_none_grid_name:** Verify single-folder mode sets `grid_name=None` in output.

5. **test_mixed_grids_separate_counts:** Create results from multiple grids, verify per-grid counts are accurate.

**Test fixture for multi-grid results:**
```python
@pytest.fixture
def multi_grid_results_folder(temp_output_dir):
    """Create multi-grid results structure."""
    for grid_name in ["Grid1", "Grid2"]:
        for mic_name in ["micro_001", "micro_002"]:
            mic_dir = temp_output_dir / grid_name / mic_name
            mic_dir.mkdir(parents=True)
            metadata = {
                "filename": f"{mic_name}.mrc",
                "grid_name": grid_name,
                "pixel_size_nm": 0.5,
                "segmentations": [
                    {"click_index": 1, "click_coords": [100, 200],
                     "mask_score": 0.9, "mask_area": 5000, "label": 1}
                ],
            }
            with open(mic_dir / "metadata.json", "w") as f:
                json.dump(metadata, f)
    return temp_output_dir
```

Run all tests to ensure no regressions in existing single-folder extraction.
  </action>
  <verify>
```bash
source ~/miniconda3/etc/profile.d/conda.sh && conda activate cryoem-annotation && pytest tests/test_extraction/test_extractor.py -v
```
  </verify>
  <done>
- All new multi-grid tests pass
- All existing extraction tests still pass (no regressions)
- Test coverage includes: multi-grid detection, grid_name extraction, CSV output, single-folder compatibility
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pytest tests/test_extraction/test_extractor.py -v` passes all tests
- [ ] `pytest tests/ -v` shows no regressions (ignore pre-existing numpy boolean failures in test_labeler.py)
- [ ] Multi-grid results produce CSV with `grid_name` column
- [ ] Single-folder results still work (grid_name=None or empty)
- [ ] Per-grid summary shows breakdown by grid
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Multi-grid extraction works with grid context preserved
- Single-folder mode unchanged (backward compatible)
- Phase 4 complete, milestone v2 ready for integration testing
</success_criteria>

<output>
After completion, create `.planning/phases/04-output-extraction/04-01-SUMMARY.md`:

# Phase 4 Plan 01: Grid-Aware Extraction Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 4 complete. Milestone v2 ready for integration testing with real multi-grid dataset.
</output>
