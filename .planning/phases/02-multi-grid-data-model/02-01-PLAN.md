---
phase: 02-multi-grid-data-model
plan: 01
type: execute
---

<objective>
Create grid-aware data structures for multi-grid dataset support.

Purpose: Enable the annotation tool to understand the `motion_corrected/{Grid}/` structure from the transfer pipeline, tracking grid context for each micrograph.
Output: GridDataset class and MicrographItem dataclass in core module, with comprehensive tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Codebase constraints:**
- Follow existing patterns in `cryoem_annotation/core/`
- Use dataclasses for data structures (Python 3.8+ compatible)
- Maintain backward compatibility with single-folder input

**Existing patterns to follow:**
@cryoem_annotation/core/image_loader.py - get_image_files() pattern for file discovery
@cryoem_annotation/core/__init__.py - Export pattern for core module

**Prior decisions affecting this phase:**
- Output structure mirrors input: `results/{Grid}/` matches `motion_corrected/{Grid}/`
- Grid-aware file browser: users jump between any micrograph from any grid

**Transfer pipeline structure:**
```
{dataset}/
  motion_corrected/
    Grid1/
      micrograph_001_DW.mrc
      micrograph_002_DW.mrc
    Grid2/
      micrograph_001_DW.mrc
      ...
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MicrographItem dataclass</name>
  <files>cryoem_annotation/core/grid_dataset.py</files>
  <action>
Create new file `cryoem_annotation/core/grid_dataset.py` with:

1. MicrographItem dataclass:
   - file_path: Path - absolute path to the micrograph file
   - grid_name: Optional[str] - grid identifier (e.g., "Grid1") or None for single-folder mode
   - micrograph_name: str - filename stem (e.g., "micrograph_001_DW")

2. Add property `display_name` that returns:
   - "{grid_name}/{micrograph_name}" if grid_name is set
   - "{micrograph_name}" if grid_name is None

3. Add `__str__` returning display_name for easy printing.

Use `@dataclass(frozen=True)` for immutability. Import from typing and pathlib only.
  </action>
  <verify>python -c "from cryoem_annotation.core.grid_dataset import MicrographItem; from pathlib import Path; m = MicrographItem(Path('/test/Grid1/mic.mrc'), 'Grid1', 'mic'); print(m.display_name)"</verify>
  <done>MicrographItem dataclass exists with file_path, grid_name, micrograph_name fields and display_name property</done>
</task>

<task type="auto">
  <name>Task 2: Create GridDataset class</name>
  <files>cryoem_annotation/core/grid_dataset.py, cryoem_annotation/core/__init__.py</files>
  <action>
Add GridDataset class to grid_dataset.py:

1. Constructor `__init__(self, root_path: Path)`:
   - Store root_path
   - Detect if multi-grid structure exists (subdirectories with image files)
   - Build internal mapping: grid_name -> List[MicrographItem]
   - For single-folder mode: use None as grid_name key

2. Detection logic in private method `_scan_directory()`:
   - Check if root_path contains subdirectories with image files
   - If yes: treat each subdirectory as a grid (sorted alphabetically)
   - If no: treat root_path itself as single grid (grid_name=None)
   - Use IMAGE_EXTENSIONS from image_loader.py for file filtering
   - Skip hidden files/directories (starting with '.')

3. Properties:
   - `is_multi_grid: bool` - True if multiple grids detected
   - `grid_names: List[str]` - sorted list of grid names (empty list for single-folder)
   - `total_micrographs: int` - total count across all grids

4. Methods:
   - `get_micrographs(grid_name: Optional[str] = None) -> List[MicrographItem]`:
     - If grid_name provided: return micrographs for that grid
     - If None: return all micrographs (flattened, sorted by grid then name)
   - `get_micrograph_count(grid_name: str) -> int`: count for specific grid

5. Export GridDataset and MicrographItem from cryoem_annotation/core/__init__.py

Use get_image_files() internally for consistent file filtering. Sort micrographs within each grid by filename.
  </action>
  <verify>python -c "from cryoem_annotation.core import GridDataset; from pathlib import Path; print('GridDataset imported successfully')"</verify>
  <done>GridDataset class detects multi-grid vs single-folder structure and provides grid-aware micrograph listing</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for GridDataset</name>
  <files>tests/test_core/test_grid_dataset.py</files>
  <action>
Create comprehensive test file with pytest:

1. Test fixtures (use tmp_path):
   - `single_folder_dataset`: flat folder with 3 .mrc files
   - `multi_grid_dataset`: motion_corrected/{Grid1,Grid2,Grid3}/ with 2-3 files each
   - `empty_dataset`: empty directory
   - `mixed_extensions`: folder with .mrc, .tif, .png files

2. TestMicrographItem class:
   - test_display_name_with_grid: verify "{grid}/{name}" format
   - test_display_name_without_grid: verify "{name}" format
   - test_str_representation: verify __str__ matches display_name
   - test_frozen_dataclass: verify immutability (assignment raises)

3. TestGridDataset class:
   - test_single_folder_detection: is_multi_grid=False, grid_names=[]
   - test_multi_grid_detection: is_multi_grid=True, grid_names sorted
   - test_total_micrographs_count: correct total across grids
   - test_get_micrographs_all: returns all in sorted order
   - test_get_micrographs_by_grid: returns only specified grid
   - test_get_micrograph_count: correct per-grid counts
   - test_empty_directory: handles gracefully, total=0
   - test_skips_hidden_files: .hidden files ignored
   - test_skips_hidden_directories: .hidden/ directories ignored
   - test_mixed_extensions: all supported extensions included

Run with: pytest tests/test_core/test_grid_dataset.py -v
  </action>
  <verify>pytest tests/test_core/test_grid_dataset.py -v --tb=short</verify>
  <done>All tests pass, covering single-folder, multi-grid, edge cases, and MicrographItem functionality</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pytest tests/test_core/test_grid_dataset.py -v` - all tests pass
- [ ] `python -c "from cryoem_annotation.core import GridDataset, MicrographItem"` - imports work
- [ ] No existing tests broken: `pytest tests/ -v --tb=short`
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- GridDataset correctly detects multi-grid vs single-folder structure
- MicrographItem carries grid context throughout pipeline
- Backward compatible with single-folder input (grid_name=None)
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-grid-data-model/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Grid Data Model Summary

**[Substantive one-liner describing what shipped]**

## Performance

- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 3
- **Files modified:** [count]

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Any changes from original plan, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 2 Plan 2, or if phase complete, ready for Phase 3]
</output>
